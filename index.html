<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Kalkulator Ilmiah Fungsional</title>
    <style>
        :root{
            /* Warna Dasar */
            --bg:#0f1724; 
            --panel:#0b1220; 
            --text-primary:#e6eef8; 
            --text-secondary:#94a3b8; 
            
            /* Warna Tombol Kustom */
            --key-default-bg: rgba(255,255,255,0.08);
            --key-special-bg: #f97316; /* Orange untuk Equal */
            --key-accent-color: #f97316; /* Warna Oranye untuk Teks Mode Aktif */
            --key-clear-color: #dc2626; /* Warna Merah untuk AC */
            --key-color: #e6eef8;
            --button-size: 58px;
        }
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
        body{background:linear-gradient(180deg,#071027 0%, #081023 100%);color:var(--text-primary);display:flex;align-items:center;justify-content:center;padding:24px}
        
        .card{
            width:min(980px,100%);
            display:grid;
            grid-template-columns:380px 1fr;
            gap:20px;
            background:var(--panel);
            padding:20px;
            border-radius:14px;
            box-shadow:0 10px 30px rgba(2,6,23,0.6);
        }
        .left{
            background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
            padding:18px;
            border-radius:10px;
        }
        /* Layar */
        .screen{
            background:transparent;
            padding:15px 5px;
            display:flex;
            flex-direction:column;
            gap:8px;
            margin-bottom: 12px;
        }
        .display{
            background:transparent;
            border:none;
            color:var(--text-secondary);
            font-size:16px;
            padding:0;
            text-align:right;
            min-height:22px;
        }
        .result{
            background:transparent;
            border:none;
            color:var(--text-primary);
            font-size:40px;
            font-weight:300;
            padding:0;
            text-align:right;
            line-height: 1;
        }
        
        /* Layout Grid Tombol Utama (6 Kolom x 6 Baris) */
        .keys{
            display:grid;
            grid-template-columns:repeat(6,1fr);
            grid-auto-rows: var(--button-size);
            gap: 12px;
        }
        
        /* Gaya Tombol Umum (Bulat) */
        button.key{
            padding:0;
            border-radius:50%;
            border:none;
            background:var(--key-default-bg);
            color:var(--key-color);
            font-size:16px;
            cursor:pointer;
            transition: background 0.1s;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }
        button.key:hover{ filter: brightness(1.4); }
        
        button.key.operator, button.key.utility, button.key.function{ font-size: 18px; font-weight: 300; }

        /* Tombol Mode RAD/DEG */
        #btn-rad.angle-active{ color: var(--key-accent-color); }

        /* Tombol C/AC - Merah */
        #btn-clear{ color: var(--key-clear-color); }

        /* Tombol Equal - Oranye Khas */
        #btn-eval{
            grid-column: 6 / 7; 
            grid-row: 6 / 7;
            background: var(--key-special-bg);
            border-radius: 50%; 
            color: white;
            font-size: 24px;
        }
        
        /* Pengaturan Tombol Khusus (Memastikan Posisi Sesuai Gambar) */
        .keys button[data-val="00"]{ grid-column: 2 / 3; border-radius: 50%; }
        .keys button[data-val="0"]{ grid-column: 3 / 4; border-radius: 50%; }
        /* TANDA KOMA/TITIK. Data val di HTML harus '.' meski tampilan ',' */
        .keys button[data-val="."]{ grid-column: 4 / 5; border-radius: 50%; } 
        .keys button[data-val="Math.E"]{ grid-column: 1 / 2; border-radius: 50%; }

        /* Operator + (Baris 5, Kolom 6) */
        .keys button[data-val="+"] { 
            grid-row: 5; 
            grid-column: 6; 
            background: var(--key-default-bg); /* Mengembalikan warna default/operator */
        }
        
        /* History & Controls (Sama seperti sebelumnya) */
        .right{
            display:flex;
            flex-direction:column;
            gap:12px;
            padding:12px;
            border-radius:10px;
            background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);
        }
        .history{flex:1;overflow-y:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
        .hist-item{padding:8px;border-radius:8px;display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:8px;background:rgba(255,255,255,0.01);cursor:pointer;}
        .hist-item:hover{background:rgba(255,255,255,0.03);}
        .small{font-size:13px;color:var(--text-secondary)}
        .btn{padding:8px 10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:inherit;cursor:pointer;font-size:14px;}
        .btn.danger{background:rgba(220,38,38,0.9);color:white}
        .muted{color:var(--text-secondary)}
        footer{font-size:11px;text-align:center;color:var(--text-secondary);margin-top:10px}
        @media (max-width:900px){
            .card{grid-template-columns:1fr;}.right{order:-1;height:260px}
        }
    </style>
</head>
<body>
    <div class="card" role="application" aria-label="Kalkulator ilmiah dengan history">
        <div class="left">
            <div class="screen" aria-live="polite">
                <input id="expr" class="display" placeholder="0" readonly aria-label="Ekspresi" />
                <div id="result" class="result" aria-label="Hasil">0</div>
            </div>

            <div class="keys" role="group" aria-label="Tombol kalkulator">
                <button class="key function" data-val="sin(">sin</button>
                <button class="key function" data-val="cos(">cos</button>
                <button class="key function" data-val="tan(">tan</button>
                <button class="key utility angle-mode" id="btn-rad" data-mode="rad">rad</button>
                <button class="key utility angle-mode" id="btn-deg" data-mode="deg">deg</button>
                <button class="key function" data-val="inv">inv</button>
                
                <button class="key function" data-val="log(">log</button>
                <button class="key function" data-val="ln(">ln</button>
                <button class="key utility" data-val="(">(</button>
                <button class="key utility" data-val=")">)</button>
                <button class="key function" data-val="exp(">e^x</button>
                <button class="key function" data-val="10**">10^x</button>
                
                <button class="key function" data-val="!">!</button>
                <button class="key utility" id="btn-clear">AC</button>
                <button class="key utility" data-val="%">%</button>
                <button class="key utility" id="btn-back">⌫</button>
                <button class="key operator" data-val="/">÷</button>
                <button class="key operator" data-val="**">^</button>

                <button class="key operator" data-val="**">^</button> 
                <button class="key" data-val="7">7</button>
                <button class="key" data-val="8">8</button>
                <button class="key" data-val="9">9</button>
                <button class="key operator" data-val="*">×</button>
                <button class="key function" data-val="sqrt(">√</button>

                <button class="key function" data-val="sqrt(">√</button>
                <button class="key" data-val="4">4</button>
                <button class="key" data-val="5">5</button>
                <button class="key" data-val="6">6</button>
                <button class="key operator" data-val="-">−</button>
                <button class="key operator" data-val="+">+</button> 

                <button class="key function" data-val="Math.PI">π</button>
                <button class="key" data-val="1">1</button>
                <button class="key" data-val="2">2</button>
                <button class="key" data-val="3">3</button>
                
                <button class="key" style="visibility: hidden;"></button> 

                <button class="key function" data-val="Math.E">e</button>
                <button class="key" data-val="00">00</button>
                <button class="key" data-val="0">0</button>
                <button class="key" data-val=".">,</button>
                
                <button class="key" style="visibility: hidden;"></button> 
                
                <button class="key equal" id="btn-eval">=</button>
                
                <button class="key" style="visibility: hidden;"></button>
            </div>

            <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
                <div class="small muted">Gunakan keyboard: angka, + - * / ( ) . Enter= =</div>
                <div class="controls">
                    <button class="btn" id="btn-copy">Salin Hasil</button>
                    <button class="btn" id="btn-save">Simpan Sekarang</button>
                </div>
            </div>
            <footer>History disimpan di <code>localStorage</code>. Maks 100 entri.</footer>
        </div>

        <div class="right">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h3 style="margin:0">History</h3>
                <div>
                    <button class="btn" id="btn-export">Export</button>
                    <button class="btn danger" id="btn-clear-all">Hapus Semua</button>
                </div>
            </div>

            <div class="history" id="history"></div>

            <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="small muted">Klik sebuah entri untuk memasukkannya kembali ke layar.</div>
                <div class="small muted">Terakhir: <span id="last-saved">-</span></div>
            </div>
        </div>
    </div>

    <script>
        (function(){
            const exprEl = document.getElementById('expr');
            const resultEl = document.getElementById('result');
            const btnRad = document.getElementById('btn-rad');
            const btnDeg = document.getElementById('btn-deg');
            const historyEl = document.getElementById('history');
            const lastSavedEl = document.getElementById('last-saved');
            
            const LS_KEY = 'calc_history_v1';
            const MAX_HISTORY = 100;

            let current = '';
            let angleMode = 'rad'; 

            // --- Logic Utilities ---
            function factorial(n) {
                if (n < 0 || !Number.isInteger(n)) return NaN;
                if (n === 0) return 1;
                let result = 1;
                for (let i = 2; i <= n; i++) {
                    result *= i;
                }
                return result;
            }

            function updateAngleModeUI() {
                document.querySelectorAll('.angle-mode').forEach(btn => btn.classList.remove('angle-active'));
                if (angleMode === 'rad') {
                    btnRad.classList.add('angle-active');
                } else {
                    btnDeg.classList.add('angle-active');
                }
            }

            function safeEval(expression){
                // 1. Sanitasi dan penggantian simbol display ke simbol JS
                // PERHATIAN: Titik '.' adalah separator desimal yang benar. Kita harus memastikan semua koma diganti titik.
                let sanitized = expression.replace(/×/g, '*')
                                         .replace(/÷/g, '/')
                                         .replace(/−/g, '-') 
                                         .replace(/,/g, '.') // Mengganti koma (,) menjadi titik (.) untuk desimal
                                         .replace(/Math\.PI/g, Math.PI)
                                         .replace(/Math\.E/g, Math.E);
                
                // 2. Faktorial: Mengganti n! dengan fungsi factorial(n)
                sanitized = sanitized.replace(/(\d+)\!/g, (match, num) => `factorial(${num})`);

                // 3. Penggantian Fungsi
                sanitized = sanitized.replace(/sqrt\(/g, 'Math.sqrt(');
                sanitized = sanitized.replace(/ln\(/g, 'Math.log(');
                sanitized = sanitized.replace(/log\(/g, 'Math.log10(');
                sanitized = sanitized.replace(/exp\(/g, 'Math.exp(');
                sanitized = sanitized.replace(/10\*\*/g, 'Math.pow(10,');
                
                // 4. Penanganan Mode Sudut
                if (angleMode === 'deg') {
                    const degWrap = (fn) => (match, p1) => {
                        // Cek apakah p1 sudah berupa ekspresi yang dievaluasi
                        try {
                            const angle = safeEval(p1);
                            return `Math.${fn}(${angle} * (Math.PI / 180))`;
                        } catch (e) {
                            // Jika belum bisa dievaluasi, biarkan sebagai ekspresi sementara
                            return `Math.${fn}((${p1}) * (Math.PI / 180))`;
                        }
                    };
                    sanitized = sanitized.replace(/sin\(([^)]+)\)/g, degWrap('sin'));
                    sanitized = sanitized.replace(/cos\(([^)]+)\)/g, degWrap('cos'));
                    sanitized = sanitized.replace(/tan\(([^)]+)\)/g, degWrap('tan'));
                } else {
                    sanitized = sanitized.replace(/sin\(/g, 'Math.sin(');
                    sanitized = sanitized.replace(/cos\(/g, 'Math.cos(');
                    sanitized = sanitized.replace(/tan\(/g, 'Math.tan(');
                }
                
                // 5. Persentase
                sanitized = sanitized.replace(/(\d+)%/g, (match, num) => `(${num}/100)`);
                sanitized = sanitized.replace(/%/g, '/100'); 

                // 6. Evaluasi
                const customScope = { Math, factorial: factorial };
                const scopeKeys = Object.keys(customScope);
                const scopeValues = Object.values(customScope);
                
                try {
                    // Gunakan Function constructor untuk evaluasi yang lebih aman
                    const fn = new Function(...scopeKeys, 'return (' + sanitized + ')');
                    const res = fn(...scopeValues);
                    
                    if(typeof res !== 'number' || !Number.isFinite(res)) throw new Error('Invalid Result');
                    
                    // Batasi desimal untuk menghindari floating point error yang terlalu panjang
                    return parseFloat(res.toFixed(12)); 
                } catch (e) {
                    throw new Error('Ekspresi tidak valid.');
                }
            }

            function updateScreen(){
                // Tampilan: Mengganti operator JS ke simbol display
                exprEl.value = current.replace(/\*\*/g, '^').replace(/\*/g, '×').replace(/\//g, '÷').replace(/-/g, '−') || '0';
                updateAngleModeUI();
                
                try{
                    if(current.trim()===''){
                        resultEl.textContent = '0';
                        return;
                    }
                    const r = safeEval(current);
                    resultEl.textContent = r;
                }catch(e){
                    resultEl.textContent = 'Error';
                }
            }
            
            // --- History Functions ---
            
            function loadHistory(){
                try{
                    const raw = localStorage.getItem(LS_KEY);
                    const arr = raw ? JSON.parse(raw) : [];
                    return Array.isArray(arr) ? arr : [];
                }catch(e){ return []; }
            }

            function saveHistory(history){
                localStorage.setItem(LS_KEY, JSON.stringify(history.slice(0, MAX_HISTORY)));
            }

            function addHistory(expr, res){
                if(expr.trim()==='') return;
                const history = loadHistory();
                // Mengubah operator internal JS menjadi operator display untuk history
                const displayExpr = expr.replace(/\*\*/g, '^').replace(/\*/g, '×').replace(/\//g, '÷').replace(/-/g, '−');
                const item = {expr:displayExpr, result:res, ts: Date.now()};
                history.unshift(item);
                saveHistory(history);
                renderHistory();
            }

            function renderHistory(){
                const history = loadHistory();
                historyEl.innerHTML = '';
                if(history.length===0){
                    historyEl.innerHTML = '<div class="muted">Belum ada riwayat.</div>';
                    lastSavedEl.textContent = '-';
                    return;
                }
                history.forEach((h, idx)=>{
                    const el = document.createElement('div');
                    el.className = 'hist-item';
                    el.addEventListener('click', ()=>{ 
                        // Saat diklik, konversi kembali ke format JS untuk ekspresi saat ini
                        current = h.expr.replace(/\^/g, '**').replace(/×/g, '*').replace(/÷/g, '/').replace(/−/g, '-'); 
                        updateScreen(); 
                    });

                    const left = document.createElement('div'); left.style.flex = '1';
                    const expr = document.createElement('div'); expr.className='expr'; expr.textContent = h.expr;
                    const ts = document.createElement('div'); ts.className='small muted'; ts.textContent = new Date(h.ts).toLocaleString();
                    left.appendChild(expr); left.appendChild(ts);
                    const right = document.createElement('div'); right.style.textAlign='right';
                    const res = document.createElement('div'); res.className='res'; res.textContent = h.result;
                    const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Hapus';
                    delBtn.addEventListener('click', (e)=>{
                        e.stopPropagation(); 
                        const arr = loadHistory(); arr.splice(idx,1); saveHistory(arr); renderHistory();
                    });
                    right.appendChild(res); right.appendChild(delBtn);
                    el.appendChild(left); el.appendChild(right);
                    historyEl.appendChild(el);
                });
                lastSavedEl.textContent = new Date(history[0].ts).toLocaleString();
            }
            
            // --- Event Listeners ---

            document.querySelectorAll('button.key[data-val]').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    let val = btn.dataset.val;
                    
                    if (val === 'inv') { return; } 

                    // Konversi tombol koma (,) menjadi titik (.) untuk logika JS
                    if (val === '.') { 
                        // Cegah dua titik berturut-turut
                        const lastChar = current.slice(-1);
                        if (lastChar === '.') return; 
                    }

                    const lastChar = current.slice(-1);
                    const isFunctionStarter = val.endsWith('(');
                    const isOperator = (c) => ['*', '/', '-', '+', '**', '!', '%', '.'].includes(c);
                    
                    // Logic Fungsi (sin(, log(, dll.)
                    if (isFunctionStarter) {
                        current += val;
                    } 
                    // Logic untuk menimpa operator (kecuali kurung)
                    else if (isOperator(lastChar) && isOperator(val) && val !== '.') {
                        current = current.slice(0, -lastChar.length) + val; 
                    } 
                    // Logic Konstanta (e, π)
                    else if (val === 'Math.PI' || val === 'Math.E') {
                        // Hanya tambahkan jika ekspresi kosong atau diakhiri operator
                        if (current.trim() === '' || isOperator(lastChar) || lastChar === '(') {
                            current += val;
                        } else {
                            // Jika sebelumnya angka, tambahkan operator kali implisit
                            current += '*' + val;
                        }
                    }
                    // Logic Normal (Angka, operator, kurung)
                    else {
                        current += val;
                    }
                    updateScreen();
                });
            });

            btnRad.addEventListener('click', () => { angleMode = 'rad'; updateScreen(); });
            btnDeg.addEventListener('click', () => { angleMode = 'deg'; updateScreen(); });

            document.getElementById('btn-clear').addEventListener('click', ()=>{ current=''; updateScreen(); });
            
            document.getElementById('btn-back').addEventListener('click', ()=>{ 
                // Logika hapus: Hapus karakter terakhir, tapi jika ada fungsi seperti 'sin(', hapus fungsi secara keseluruhan.
                const funcMatch = current.match(/(sin\(|cos\(|tan\(|log\(|ln\(|exp\(|sqrt\(|10\*\*)$/);
                if (funcMatch) {
                     current = current.slice(0, -funcMatch[0].length);
                } else {
                    current = current.slice(0,-1); 
                }
                updateScreen(); 
            });
            
            document.getElementById('btn-eval').addEventListener('click', ()=>{
                try{
                    const r = safeEval(current);
                    resultEl.textContent = r;
                    addHistory(current, r);
                    current = String(r);
                    updateScreen();
                }catch(e){
                    resultEl.textContent = 'Error';
                }
            });
            
            // Keyboard support 
            window.addEventListener('keydown', (ev)=>{
                const k = ev.key;
                let val = '';
                let buttonToClick = null;

                if (k === 'Backspace') { ev.preventDefault(); document.getElementById('btn-back').click(); return; }
                if (k === 'Enter' || k === '=') { ev.preventDefault(); document.getElementById('btn-eval').click(); return; }
                if (k.toLowerCase() === 'c' && (ev.ctrlKey || ev.metaKey)) { ev.preventDefault(); document.getElementById('btn-clear').click(); return; }

                if (k.match(/^[0-9()]$/)) {
                    buttonToClick = document.querySelector(`button.key[data-val="${k}"]`);
                } else if (k === '.' || k === ',') { // Titik atau Koma Desimal
                    buttonToClick = document.querySelector(`button.key[data-val="."]`);
                } else if (k === '*') {
                    buttonToClick = document.querySelector(`button.key[data-val="*"]`);
                } else if (k === '/') {
                    buttonToClick = document.querySelector(`button.key[data-val="/"]`);
                } else if (k === '-') {
                    buttonToClick = document.querySelector(`button.key[data-val="-"]`);
                } else if (k === '+') {
                    buttonToClick = document.querySelector(`button.key[data-val="+"]`);
                } else if (k === '^') {
                    buttonToClick = document.querySelector(`button.key[data-val="**"]`);
                } else if (k === '!') {
                    buttonToClick = document.querySelector(`button.key[data-val="!"]`);
                } else if (k === '%') {
                    buttonToClick = document.querySelector(`button.key[data-val="%"]`);
                }

                if (buttonToClick) {
                    ev.preventDefault();
                    buttonToClick.click();
                }
            });


            // initialize
            renderHistory(); 
            updateScreen(); 
            // Tambahkan event listener untuk Salin Hasil
            document.getElementById('btn-copy').addEventListener('click', () => {
                const resultText = resultEl.textContent;
                navigator.clipboard.writeText(resultText).then(() => {
                    alert('Hasil "' + resultText + '" telah disalin!');
                }).catch(err => {
                    console.error('Gagal menyalin: ', err);
                });
            });

            // Tambahkan event listener untuk Simpan Sekarang
            document.getElementById('btn-save').addEventListener('click', () => {
                const expr = exprEl.value;
                const result = resultEl.textContent;
                if (result !== '0' && result !== 'Error' && expr !== '0') {
                    addHistory(current, result);
                    alert('Ekspresi telah disimpan ke riwayat.');
                } else {
                    alert('Tidak ada ekspresi valid untuk disimpan.');
                }
            });

            // Tambahkan event listener untuk Hapus Semua Riwayat
            document.getElementById('btn-clear-all').addEventListener('click', () => {
                if(confirm("Apakah Anda yakin ingin menghapus SEMUA riwayat? Tindakan ini tidak dapat dibatalkan.")){
                    saveHistory([]);
                    renderHistory();
                    alert('Riwayat telah dihapus.');
                }
            });


        })();
    </script>
</body>
</html>
